<properties 
	pageTitle="使用 Live Connect (JavaScript) 驗證應用程式" 
	description="了解如何從 Windows 市集應用程式在 Azure 行動服務中使用 Live Connect 單一登入。" 
	services="mobile-services" 
	documentationCenter="windows" 
	authors="ggailey777" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile-windows-store" 
	ms.devlang="javascript" 
	ms.topic="article" 
	ms.date="04/08/2015" 
	ms.author="glenga"/>

# 使用 Microsoft 帳戶以用戶端管理的驗證方式驗證您的 Windows 市集應用程式

[AZURE.INCLUDE [mobile-services-selector-single-signon](../../includes/mobile-services-selector-single-signon.md)]

##概觀
本主題說明如何從您的 Windows 市集應用程式在 Azure 行動服務中驗證使用者。在本教學課程中，您會使用 Live Connect 將驗證新增至快速入門專案。在經過 Live Connect 成功驗證後，畫面會顯示名稱和使用者識別碼值來歡迎已登入使用者。

>[AZURE.NOTE]本教學課程示範使用用戶端管理的驗證和 Live SDK 的優點。這可讓您更輕鬆地使用行動服務來驗證已登入使用者。您也可以要求額外的範圍，讓您的應用程式也能存取如 OneDrive 的資源。服務管理的驗證則提供更一般化的體驗，並支援多種驗證提供者。如需有關服務管理的驗證的詳細資訊，請參閱[將驗證新增至您的應用程式](mobile-services-windows-store-javascript-get-started-users.md)主題。

本教學課程需要下列各項：

+ [Live SDK for Windows]
+ Microsoft Visual Studio 2012 Express for Windows 8 RC 或更新版本
+ 您還必須先完成[將行動服務新增至現有的應用程式]教學課程。

##註冊應用程式來使用 Microsoft 帳戶進行驗證

若要能夠驗證使用者，您必須在 Microsoft 帳戶開發人員中心註冊您的應用程式。然後您必須將此註冊連接到您的行動服務。請完成下列主題中的步驟以建立 Microsoft 帳戶註冊，並將註冊連接到您的行動服務。

+ [註冊應用程式來使用 Microsoft 帳戶登入](mobile-services-how-to-register-microsoft-authentication.md)

##<a name="permissions"></a>限制只有通過驗證的使用者具有權限

接著您必須限制資源的存取權，在此案例中，要確保 *TodoItems* 資料表只能被登入的使用者存取。

[AZURE.INCLUDE [mobile-services-restrict-permissions-windows](../../includes/mobile-services-restrict-permissions-windows.md)]

##<a name="add-authentication"></a>將驗證新增至應用程式

最後，您要新增 Live SDK 並用它來驗證您應用程式中的使用者。

1. 在 [方案總管] 中，以滑鼠右鍵按一下方案，然後選取 [管理 NuGet 封裝]。

2. 在左窗格中選取 [線上] 類別、搜尋 **LiveSDK**，按一下 [Live SDK] 封裝上的 [安裝]，然後接受授權合約。

  	這樣會將 Live SDK 新增至方案中。

3. 開啟 default.html 專案檔案，並在 `<script>` 元素中新增下列 `<head>` 元素。

        <script src="/js/wl.js"></script>

5. 在 **app.OnActivated** 方法多載中，以下列程式碼取代 **refreshTodoItems** 方法的呼叫：
	
        // Set the mobileClient variable to client variable generated by the tooling.
        var mobileClient = <yourClient>;

        var session = null;
        var login = function () {
            return new WinJS.Promise(function (complete) {
                WL.login({ scope: "wl.basic" }).then(function (result) {
                    session = result.session;

                    WinJS.Promise.join([
                        WL.api({ path: "me", method: "GET" }),
                        mobileClient.login(result.session.authentication_token)
                    ]).done(function (results) {
                        // Build the welcome message from the Microsoft account info.
                        var profile = results[0];                            
                        var title = "Welcome " + profile.first_name + "!";
                        var message = "You are now logged in as: "
                            + mobileClient.currentUser.userId;
                        var dialog = new Windows.UI.Popups.MessageDialog(message, title);
                        dialog.showAsync().then(function () {
                            // Reload items from the mobile service.
                            refreshTodoItems();
                        }).done(complete);
                        
                    }, function (error) {

                    });
                }, function (error) {
                    session = null;
                    var dialog = new Windows.UI.Popups.MessageDialog("You must log in.", "Login Required");
                    dialog.showAsync().done(complete);
                });
            });
        }

        var authenticate = function () {
            // Block until sign-in is successful.
            login().then(function () {
                if (session === null) {
                    // Authentication failed, try again.
                    authenticate();
                }
            });
        }

		// Initialize the Live client.
        WL.init({
            redirect_uri: mobileClient.applicationUrl
        });

		// Start the sign-in process.
        authenticate();

    這會初始化 Live Connect 用戶端、將新的登入要求傳送至 Microsoft 帳戶、將傳回的驗證權杖傳送至行動服務，然後顯示登入使用者的相關資訊。

	>[AZURE.NOTE]理想情況下，您不應在每次執行應用程式時，都要求 Live Connection 驗證權杖或行動服務授權權杖。這麼做不只效率不彰，而且如果同時有許多用戶試圖啟動您的應用程式時，還可能遇到使用量相關的問題。更好的方法是快取權杖並先嘗試使用快取的行動服務權杖，然後再呼叫 **LoginWithMicrosoftAccountAsync**。如需如何快取此權杖的範例，請參閱[開始使用驗證](mobile-services-windows-store-javascript-get-started-users.md#tokens)
	
7. 將上述程式碼中第一行的 `<yourClient>` 值取代為您將專案連接到行動服務時所新增的 .js 檔案所定義的變數。
		
8. 按 F5 鍵執行應用程式，並以您的 Microsoft 帳戶登入。

   	成功登入後，應用程式應會正確無誤地執行，而且您應能夠查詢行動服務並更新資料。

## <a name="next-steps"> </a>後續步驟

在下一堂教學課程[使用指令碼授權使用者]中，您將使用行動服務根據通過驗證使用者所提供的使用者 ID 值，並用它來篩選行動服務所傳回的資料。如需關於如何使用其他識別提供者以進行驗證的詳細資訊，請參閱[開始使用驗證]。

<!-- Anchors. -->
[Register your app for authentication and configure Mobile Services]: #register
[Restrict table permissions to authenticated users]: #permissions
[Add authentication to the app]: #add-authentication
[Next Steps]: #next-steps

<!-- Images. -->

<!-- URLs. -->
[Submit an app page]: http://go.microsoft.com/fwlink/p/?LinkID=266582
[My Applications]: http://go.microsoft.com/fwlink/p/?LinkId=262039
[Live SDK for Windows]: http://go.microsoft.com/fwlink/p/?LinkId=262253
[將行動服務新增至現有的應用程式]: mobile-services-windows-store-javascript-get-started-data.md
[開始使用驗證]: mobile-services-windows-store-javascript-get-started-users.md
[使用指令碼授權使用者]: ../mobile-services-windows-store-javascript-authorize-users-in-scripts.md

[Azure Management Portal]: https://manage.windowsazure.com/
 

<!---HONumber=July15_HO2-->