<properties 
	pageTitle="將 Web 應用程式與 Azure 虛擬網路整合" 
	description="示範如何將 Azure App Service 中的 Azure Web 應用程式連接到新的或現有的 Azure 虛擬網路" 
	services="app-service\web" 
	documentationCenter="" 
	authors="cephalin" 
	manager="wpickett" 
	editor=""/>

<tags 
	ms.service="app-service-web" 
	ms.workload="web" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/24/2015" 
	ms.author="cephalin"/>

# 將 Web 應用程式與 Azure 虛擬網路整合 #
本文件說明虛擬網路整合預覽功能，以及示範如何使用 [Azure App Service](http://go.microsoft.com/fwlink/?LinkId=529714) 中的 Web Apps 來設定此功能。如果您不熟悉 Azure 虛擬網路，這是讓您利用 Azure 和內部部署資源建置混合式解決方案的功能。

這項整合能讓您的 Web 應用程式存取虛擬網路中的資源，但不授與從虛擬網路存取 Web 應用程式的權限。一些標準案例包括當 Web 應用程式需要存取在虛擬網路中之虛擬機器 (甚至是您擁有的資料中心) 內執行的資料庫或 Web 服務時。它不允許您掛接磁碟機。目前也不支援與虛擬網路中的驗證系統整合。這項功能目前僅供預覽，不過在 GA 之前，我們仍會持續改良。

如需 Azure 虛擬網路的詳細資料，請參閱「虛擬網路概觀」以取得 Azure 虛擬網路的使用案例和優點。

## 開始使用 ##
在將 Web 應用程式連接至虛擬網路之前，請留意以下事項。

1.	唯有以「標準」定價層中的 App Service 方案為基礎運作的 Web Apps 能連接至虛擬網路。「免費」、「共用」及「基本」方案中的 Web Apps 均無法連接至虛擬網路。
2.	如果目標虛擬網路已存在，您必須先以動態路由閘道啟用其點對站台連線，才能使該虛擬網路與 Web 應用程式連線。如果您以靜態路由設定閘道，便無法啟用點對站台的虛擬私人網路 (VPN)。
3.	您最多只能在應用程式服務方案中設定 5 個網路。一個 Web 應用程式一次只能連接一個網路。這 5 個網路可供同一個應用程式服務方案中任意數量的 Web 應用程式使用。  

您可以選擇連接新的或現有的虛擬網路。如果您建立新網路，系統會為您預先設定閘道。請注意，新虛擬網路的建立和設定需要幾分鐘的時間才能完成。

如果您的 Web 應用程式不在標準應用程式服務方案中，UI 會讓您知道應該要升級，並授與您存取定價層的權限。

![](./media/web-sites-integrate-with-vnet/upgrade-to-standard.png)

## 系統的運作方式 ##
此功能實際上會使用點對站台的 VPN 技術，將 Web 應用程式連接至虛擬網路。Azure App Service 中的 Web Apps 具備多租用戶的系統架構，其會防止在虛擬網路中直接佈建 Web 應用程式，就像使用虛擬機器所做的一樣。藉由以點對站台技術為基礎來進行建置，我們得以將網路存取限制為僅限裝載 Web 應用程式的虛擬機器。在這些 Web 應用程式主機上，我們更進一步限制網路的存取權限，因此 Web 應用程式只能存取您設定為供其存取的網路。

為了保護網路，只將存取權限授與需要存取網路的 Web 應用程式，我們施行的必要措施將會禁止建立 SMB 連線的能力。雖然您仍然可以存取遠端資源，不過掛接遠端磁碟機並不包括在內。

![](./media/web-sites-integrate-with-vnet/how-it-works.png)
 
如果您尚未設定虛擬網路的 DNS 伺服器，便需要使用 IP 位址。請務必透過防火牆向需要的端點公開連接埠。至於連線測試，目前唯一可行的方法是使用能呼叫所需端點的 Web 應用程式或 Web 工作。諸如 ping 或 nslookup 等工具目前無法經由 Kudu 主控台發揮作用。這方面是我們即將要改善的要點。

## 連接既存的網路 ##
若要將 Web 應用程式連接到虛擬網路，請前往 Web 應用程式的分頁，在 [網路] 區段中按一下虛擬網路磚，然後選取任一個既存的網路。

![](./media/web-sites-integrate-with-vnet/connect-to-existing-vnet.png)
 
接著，系統會建立憑證以向您的虛擬網路進行驗證，確認其為訂用帳戶中第一個與該網路建立連線的 Web 應用程式。若要查看憑證，請前往 [Azure 入口網站](http://go.microsoft.com/fwlink/?LinkId=529715)、瀏覽至 [虛擬網路]、選取網路，然後選取 [憑證] 索引標籤。

在上圖中，您可以看見名為 cantConnectVnet 的網路呈現灰色且無法選取。發生這種情況的原因只有兩個。這表示您並未在網路中啟用點對站台 VPN，抑或是尚未在虛擬網路中佈建動態路由閘道。一旦滿足以上兩個項目後，就可以選取用來與 Web 應用程式整合的虛擬網路。

## 建立及連接到新的虛擬網路 ##
除了連接到既存的虛擬網路之外，您還可以從 Azure 入口網站 UI 建立新的虛擬網路，然後自動與其連線。若要這樣做，請遵循到達虛擬網路 UI 的路徑，然後選取 [建立新的虛擬網路]。開啟的 UI 可讓您為網路命名、指定位址空間，以及設定虛擬網路所用之 DNS 伺服器的位址。

![](./media/web-sites-integrate-with-vnet/create-new-vnet.png)
 
利用已設定之閘道建立新虛擬網路可能需要花費 30 分鐘的時間才能完成。在這段時間內，UI 會告知您系統仍在運作中，並且會顯示以下訊息。

![](./media/web-sites-integrate-with-vnet/new-vnet-progress.png)

一旦網路加入 Web 應用程式之後，該 Web 應用程式將能透過 TCP 或 UDP 存取該虛擬網路中的資源。對於透過站台對站台 VPN 提供給虛擬網路使用的內部部署系統，如果您想要存取該系統內的資源，便需要在自己的企業網路中新增路由，以允許流量從您的網路流向虛擬網路中所設定的點對站台位址。

成功完成整合後，Azure 入口網站會顯示有關連線的基本資訊、提供中斷 Web 應用程式和網路連線的方法，以及提供用來驗證連線之憑證的同步處理方法。當憑證到期或遭到撤銷時，您將需要進行同步處理。

![](./media/web-sites-integrate-with-vnet/vnet-status-portal.png)

##管理虛擬網路連線##
您可以造訪應用程式服務方案的分頁，查看目前與應用程式服務方案內之 Web 應用程式相關聯的所有虛擬網路清單。您最多可以擁有 5 個與應用程式服務方案相關聯的網路。

如果您將應用程式服務方案調整為「免費」、「共用」或「基本」等較低階的方案，該方案中 Web 應用程式所用的虛擬網路連線將遭到停用。如果您將方案調整回標準方案，系統將會重新建立先前的網路連線。

此時，您無法在 Azure 中將現有的虛擬機器移動到虛擬網路中。您需要在虛擬機器建立期間將其佈建到該虛擬網路中。

## 存取內部部署資源 ##
在操作已設定站台對站台 VPN 的虛擬網路時，若要提供從 Web 應用程式存取內部部署資源的權限，您需要採取額外步驟。您需要將路由新增至內部部署網路，使流量得以從網路流向在虛擬網路中設定的點對站台位址。若要查看點對站台連線的 IP 範圍，請前往 Azure 入口網站的 [網路] 區域，如下圖所示。

![](./media/web-sites-integrate-with-vnet/vpn-to-onpremise.png)

## 憑證 ##
為了與虛擬網路建立安全連線，我們需要實施憑證交換。在目前的網路入口網站中，您可以查看 Web Apps 產生的公開憑證指紋，如下圖所示。

![](./media/web-sites-integrate-with-vnet/vpn-to-onpremise-certificate.png)

如果憑證因任何原因而失去同步 (例如，從網路入口網站意外遭到刪除)，連線將會中斷。若要修正問題，Web Apps 虛擬網路 UI 中的 [同步連線] 動作可供您重新建立連線。

當您將 DNS 新增至虛擬網路，抑或是將站台對站台 VPN 新增至網路時，也必須使用此動作。

![](./media/web-sites-integrate-with-vnet/vnet-sync-connection.png)

## 與混合式連線的比較 ##
Web Apps 另外提供一項稱為「混合式連線」的功能，此功能在某些方面與虛擬網路整合非常類似。儘管這兩項功能的使用案例有重複之處，但它們無法取代彼此。透過混合式連線，您可以與混合網路中的多個應用程式端點建立連線。虛擬網路功能可讓您的 Web 應用程式與連接至內部部署網路的虛擬網路連線。如果您將所有資源放置在該網路的範圍內，這項功能將能發揮良好的效果。

另一個差異在於，您需要安裝轉接代理程式，混合式連線才能正常運作。此代理程式需要在 Windows Server 執行個體上執行。在虛擬網路功能的協助下，您不需要安裝任何項目，且該功能可讓您忽略主控作業系統的限制存取遠端資源。

現階段，這兩項功能的價格層也不盡相同。就價格最低廉的階層來看，這是因為混合式連線功能格外適合用於開發/測試案例，並且只提供存取權限給少量的端點。虛擬網路功能則可讓您存取 VNET 中的所有項目，或與 VNET 連接的所有項目。

>[AZURE.NOTE]如果您想在註冊 Azure 帳戶前開始使用 Azure App Service，請移至[試用 App Service](http://go.microsoft.com/fwlink/?LinkId=523751)，即可在 App Service 中立即建立短期入門 Web 應用程式。不需要信用卡；沒有承諾。

## 變更的項目
* 如需從網站變更為 App Service 的指南，請參閱：[Azure App Service 及其對現有 Azure 服務的影響](http://go.microsoft.com/fwlink/?LinkId=529714)
* 如需從舊的入口網站變更為新入口網站的指南，請參閱：[巡覽預覽入口網站的參考](http://go.microsoft.com/fwlink/?LinkId=529715)
 

<!---HONumber=62-->