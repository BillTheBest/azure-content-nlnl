<properties
	pageTitle="Site Recovery 中的容錯移轉" 
	description="Azure Site Recovery 可協調虛擬機器和實體伺服器的複寫、容錯移轉及復原作業。了解如何容錯移轉到 Azure 或次要資料中心。" 
	services="site-recovery" 
	documentationCenter="" 
	authors="rayne-wiselman" 
	manager="jwhit" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="05/29/2015" 
	ms.author="raynew"/>

# Site Recovery 中的容錯移轉

[Azure Site Recovery 服務](site-recovery-overview.md)提供健全的商務持續性和災害復原 (BCDR) 解決方案，可協調及自動化複寫並容錯移轉至 Azure，或是次要的內部部署資料中心，藉以保護您的內部部署實體伺服器和虛擬機器。本文提供復原 (容錯移轉和容錯回復) 使用 Site Recovery 保護的虛擬機器與實體伺服器的相關資訊和指示。

如果您在閱讀本文後有任何問題，請將問題張貼在 [Azure 復原服務論壇](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)。


## 概觀

在設定對於虛擬機器和實體伺服器的保護之後，它們就會開始複寫到次要位置。執行複寫之後，您就可以在需要時執行容錯移轉。Site Recovery 支援數種類型的容錯移轉。

**容錯移轉** | **執行的時機** | **詳細資料** | **處理程序**
---|---|---|---
**測試容錯移轉** | 執行以驗證您的複寫策略，或執行災害復原訓練 | <p>沒有資料遺失或停機時間</p><p>不會影響到複寫</p><p>不會影響到生產環境</p> | <p>開始容錯移轉</p><p>指定如何在容錯移轉之後將測試機器連接到網路</p><p>在 [工作] 索引標籤上追蹤進度。建立測試機器並在次要位置中啟動</p><p>Azure - 連接到 Azure 入口網站中的機器</p><p>次要站台 - 存取相同主機和雲端上的機器</p><p>完成測試並自動清除測試容錯移轉設定。</p>
**計劃性容錯移轉** | <p>執行以符合法規需求</p><p>執行計劃性維護</p><p>執行以容錯移轉資料，使工作負載能夠在發生已知中斷時持續執行；例如，發生預期的電源故障或嚴峻的氣象報告</p> <p>在從主要位置移轉到次要位置後執行以進行容錯回復 | <p>沒有資料遺失</p><p>在系統用來將主要位置上的虛擬機器關機並使其在次要位置啟動期間，會產生停機時間。</p><p>當目標電腦在容錯移轉之後成為來源機器時，虛擬機器就會受到影響。</p> | <p>開始容錯移轉</p><p>在 [工作] 索引標籤上追蹤進度。來源機器均已關閉</p><p>在次要位置啟動複本機器</p><p>Azure - 連接到 Azure 入口網站中的複本機器</p><p>次要站台 - 存取同一部主機上和相同雲端中的機器</p><p>認可容錯移轉</p>
**非計劃性容錯移轉** | <p>當主要站台因為發生非預期的事件 (例如，停電或病毒攻擊) 而變成無法存取時，執行這種類型的容錯移轉反應方式</p><p>您可以執行非計劃性容錯移轉，即使主要站台無法使用，還是可以完成。<p> | <p>資料遺失取決於複寫頻率設定</p> <p>資料將根據其最後一次同步處理的時間保持最新狀態</p> | <p>開始容錯移轉</p><p>在 [工作] 索引標籤上追蹤進度。選擇性地嘗試關閉虛擬機器並同步處理最新資料</p><p>在次要位置啟動複本機器</p><p>Azure - 連接到 Azure 入口網站中的複本機器</p><p>次要站台會存取同一部主機上和相同雲端中的機器</p><p>認可容錯移轉</p>


支援的容錯移轉類型取決於您的部署案例。

**容錯移轉方向** | **測試容錯移轉** | **計劃性容錯移轉** | **非計劃性容錯移轉**
---|---|---|---
從主要 VMM 站台到次要 VMM 站台 | 支援 | 支援 | 支援 
從次要 VMM 站台到主要 VMM 站台 | 支援 | 支援 | 支援
雲端到雲端 (單一 VMM 伺服器) | 支援 | 支援 | 支援
從 VMM 站台到 Azure | 支援 | 支援 | 支援 
從 Azure 到 VMM 站台 | 不支援 | 支援 | 不支援 
從 Hyper-V 站台到 Azure | 支援 | 支援 | 支援
從 Azure 到 Hyper-V 站台 | 不支援 | 支援 | 不支援
從 VMware 站台到 Azure | 不支援 |這種情況會使用連續複寫，因此計劃性與非計劃性容錯移轉之間並無差別。您選取 [容錯移轉] | NA
從實體伺服器到 Azure | 不支援 | 這種情況會使用連續複寫，因此計劃性與非計劃性容錯移轉之間並無差別。您選取 [容錯移轉] | NA

## 容錯移轉和容錯回復

根據您的部署而定，您可以將虛擬機器容錯移轉到次要的內部部署站台或 Azure。容錯移轉到 Azure 的機器會建立來做為 Azure 虛擬機器。您可以容錯移轉單一虛擬機器或實體伺服器，或是復原方案。復原方案包含一或多個排序的群組，其中含有受保護的虛擬機器或實體伺服器。它們可用來協調多部機器的容錯移轉，這類機器會根據它們所屬的群組來進行容錯移轉。[閱讀更多](site-recovery-create-recovery-plans.md)復原方案的相關資訊。

當容錯移轉完成且您的機器已在次要位置啟動並執行之後，請注意：

- 如果您已容錯移轉到 Azure，則在容錯移轉之後，系統將不會保護或複寫主要或次要位置中的機器。在 Azure 中，虛擬機器是儲存於異地複寫儲存體中，其可提供彈性，但不會複寫。
- 如果您進行非計劃性容錯移轉到次要站台，則在容錯移轉之後，將不會保護或複寫次要位置中的機器。
- 如果您進行計劃性容錯移轉到次要站台，則在容錯移轉之後，將會保護或複寫次要位置中的機器。
 

### 從次要站台進行容錯回復

從次要站台容錯回復到主要站台所使用的程序，與從主要站台容錯移轉到次要站台的程序相同。認可並完成從主要站台容錯移轉到次要資料中心之後，您就能在主要站台成為可用時，起始反向複寫。反向複寫會藉由同步處理差異資料，來起始次要站台和主要站台之間的複寫。反向複寫會讓虛擬機器進入受保護的狀態，但是次要資料中心仍是使用中位置。為了讓主要站台成為使用中位置，您可以起始從次要位置到主要位置的計劃性容錯移轉，後面接著另一個反向複寫。

### 從 Azure 容錯回復

如果您已容錯移轉到 Azure，虛擬機器就會受到虛擬機器的 Azure 復原功能所保護。若要使原始的主要站台變成使用中位置，您可以執行計劃性容錯移轉。您可以容錯回復到原始位置，或者，如果您的原始站台無法使用，則可回復到其他位置。若要在容錯回復到主要位置後再次啟動複寫，您可以起始反向複寫。

### 容錯移轉考量

- **容錯移轉之後的 IP 位址** - 根據預設，已容錯移轉的機器 IP 位址會與來源電腦的 IP 位址不同。如果您想要保留同一個 IP 位址，請參閱： 
	- **次要站台** - 如果您要容錯移轉到次要站台且想要保留 IP 位址，請[閱讀](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx)這篇文章。請注意，如果您的 ISP 支援公用 IP 位址，則您可以保留它。
	- **Azure** - 如果您要容錯移轉到 Azure，您可以指定要在虛擬機器屬性的 [設定] 索引標籤中指派的 IP 位址 。您無法在容錯移轉到 Azure 後保留公用 IP 位址。您可以保留非 RFC 1918 位址空間來做為內部位址。
- **部分容錯移轉** - 如果您想要容錯移轉部分站台，而非整個站台，請注意： 
	- **次要站台** - 如果您將部分的主要站台容錯移轉到次要站台，且想要連回主要站台，請使用站台對站台 VPN 連線，將次要站台上已容錯移轉的應用程式連接到在主要站台上執行的基礎結構元件。如果整個子網路都會進行容錯移轉，您就能保留虛擬機器的 IP 位址。如果您容錯移轉部分子網路，就無法保留虛擬機器的 IP 位址，因為無法在站台間分割子網路。
	- **Azure** - 如果您將部分站台容錯移轉到 Azure，且想要連回主要站台，您可以使用站台對站台 VPN，將 Azure 中已容錯移轉的應用程式連接到在主要站台上執行的基礎結構元件。請注意，如果整個子網路都會進行容錯移轉，您就能保留虛擬機器的 IP 位址。如果您容錯移轉部分子網路，就無法保留虛擬機器的 IP 位址，因為無法在站台間分割子網路。
 
- **磁碟機代號** - 如果想要在容錯移轉後保留虛擬機器上的磁碟機代號，您可以將虛擬機器的 SAN 原則設定為 [開啟]。虛擬機器磁碟會自動上線。[閱讀更多資訊](https://technet.microsoft.com/library/gg252636.aspx)。
- **路由傳送用戶端要求** - Site Recovery 可搭配 Azure 流量管理員使用，在容錯移轉之後，將用戶端要求路由傳送到您的應用程式。




## 執行測試容錯移轉

當您執行測試容錯移轉時，系統會要求您選取用以測試複本電腦的網路設定。您有許多選項。

**測試容錯移轉選項** | **說明** | **容錯移轉檢查** | **詳細資料**
---|---|---|---
**容錯移轉到 Azure - 沒有網路** | 請勿選取目標 Azure 網路 | 在 Azure 中以預期方式啟動容錯移轉檢查來測試虛擬機器 | <p>復原方案中的所有測試虛擬機器都會新增於單一雲端服務中，且可彼此連接</p><p>在容錯移轉之後，機器便無法連接到 Azure 網路。</p><p>使用者可以使用公用 IP 位址連接到測試電腦</p>
**容錯移轉到 Azure - 透過網路** | 選取目標 Azure 網路 | 容錯移轉會檢查測試機器是否已連接到網路 | <p>建立與您的 Azure 生產網路隔離開來的 Azure 網路，並設定複寫虛擬機器的基礎結構，使其可如預期般運作。</p><p>測試虛擬機器的子網路是以容錯移轉的虛擬機器在發生計劃性或非計劃性容錯移轉時預期要連接的子網路為基礎。</p>
**容錯移轉到次要 VMM 站台 - 沒有網路** | 請勿選取 VM 網路 | 容錯移轉會檢查測試機器是否已建立<p>測試虛擬機器將建立在複本虛擬機器所在之主機的相同主機上。它不會新增到複本虛擬機器所在的雲端。</p></p>| <p>已容錯移轉的機器將無法連接到任何網路。</p><p>機器可以在建立之後連接到 VM 網路</p>
**容錯移轉到次要 VMM 站台 - 透過網路** | 選取現有的 VM 網路 | 容錯移轉會檢查虛擬機器是否已建立 | <p>測試虛擬機器將建立在複本虛擬機器所在之主機的相同主機上。它不會新增到複本虛擬機器所在的雲端。</p><p>建立已與您的生產網路隔離開來的 VM 網路</p><p>如果您使用的是 VLAN 架構的網路，建議您基於此目的，在 VMM 中建立個別個邏輯網路 (不會用於生產環境)。這個邏輯網路可基於測試容錯移轉的目的，用來建立 VM 網路。</p><p>邏輯網路應該至少會與裝載虛擬機器之所有 Hyper-V 伺服器的其中一個網路介面卡相關聯。</p><p>針對 VLAN 邏輯網路，應該將您新增到邏輯網路的網路站台隔離開來。</p><p>如果您使用的是 Windows 網路虛擬化架構的邏輯網路，Azure Site Recovery 就會自動建立隔離的 VM 網路。</p>
**容錯移轉到次要 VMM 站台 - 建立網路** | 暫時性測試網路將根據您在 [邏輯網路] 及其相關網路站台中指定的設定自動建立 | 容錯移轉會檢查虛擬機器是否已建立 | <p>如果復原方案會使用多個 VM 網路，請使用這個選項。如果您使用的是 Windows 網路虛擬化網路，這個選項會使用複本虛擬機器網路中的相同設定 (子網路和 IP 位址集區) 自動建立 VM 網路。這些 VM 網路會在測試容錯移轉完成之後自動清除。</p><p>測試虛擬機器將建立在複本虛擬機器所在之主機的相同主機上。它不會新增到複本虛擬機器所在的雲端。</p>

請注意：

- 複寫到次要站台時，複本機器所使用的網路類型不需要與用來測試容錯移轉的邏輯網路類型相符，但某些組合可能無法運作。如果複本會使用 DHCP 和 VLAN 架構的隔離，則複本的 VM 網路不需要靜態 IP 位址集區。因此，使用 Windows 網路虛擬化來測試容錯移轉將不會運作，因為沒有任何位址集區可供使用。此外，如果複本網路是「未隔離」且測試網路是 Windows 網路虛擬化，則測試容錯移轉將無法運作。這是因為「未隔離」的網路沒有建立 Windows 網路虛擬化網路所需的子網路。
- 容錯移轉之後，用來將複本虛擬機器連接到對應 VM 網路的方式，取決於 VM 網路在 VMM 主控台中的設定方式：
	- **設定為未隔離或 VLAN 隔離的 VM 網路** - 如果已針對 VM 網路定義 DHCP，則複本虛擬機器將使用針對相關聯邏輯網路中網路站台所指定的設定連接到 VLAN 識別碼。虛擬機器將從可用的 DHCP 伺服器接收其 IP 位址。您不需要針對目標 VM 網路定義靜態 IP 位址集區。如果已針對 VM 網路使用靜態 IP位址集區，則複本虛擬機器將使用針對相關聯邏輯網路中網路站台所指定的設定連接到 VLAN 識別碼。虛擬機器將從針對 VM 網路所定義的集區接收其 IP 位址。如果靜態 IP 位址集區未定義於目標 VM 網路上，則 IP 位址配置將會失敗。IP 位址集區應建立於您即將用來保護與復原的來源和目標 VMM 伺服器上。
	- **含有 Windows 網路虛擬化的 VM 網路** - 如果使用此設定來設定 VM 網路，就應該針對目標 VM 網路定義靜態集區，而不論是否已將來源 VM 網路設定為使用 DHCP 或靜態 IP 位址集區。如果您定義 DHCP，目標 VMM 伺服器將用來做為 DHCP 伺服器，並提供來自針對目標 VM 網路定義之集區的 IP 位址。如果已定義來源伺服器的靜態 IP 位址用法，則目標 VMM 伺服器將配置來自集區的 IP 位址。在這兩種情況下，如果未定義靜態 IP 位址集區，IP 位址配置將會失敗。




### 執行從內部部署到 Azure 的測試容錯移轉

此程序說明如何針對復原方案執行測試容錯移轉。或者，您可以在 [虛擬機器] 索引標籤上針對單一機器執行容錯移轉。

1. 選取 [復原方案] > *recoveryplan_name*。按一下 [容錯移轉] > [測試容錯移轉]。
2. 在 [確認測試容錯移轉] 頁面上，指定複本機器在容錯移轉後連接到 Azure 網路的方式。
3. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰] 中，選取當您在提供者安裝期間啟用資料加密時所發出的憑證。 
4. 在 [工作] 索引標籤上追蹤容錯移轉進度。您應該可以在 Azure 入口網站中看到測試複本機器。
5. 您可以從內部部署站台存取 Azure 中的複本機器，而該站台會起始與虛擬機器的 RDP 連線。您必須在虛擬機器的端點上開啟連接埠 3389。
5. 完成之後，在容錯移轉到達 [完成測試] 階段時，請按一下 [完成測試] 來完成。
5. 在 [記事] 中，記錄並儲存關於測試容錯移轉的任何觀察。
8. 按一下 [測試容錯移轉已完成]，即可自動清除測試環境。完成此動作之後，測試容錯移轉將顯示 [完成]**** 狀態。

> [AZURE.NOTE]如果測試容錯移轉持續兩週以上，系統即會強制完成該測試容錯移轉。任何在測試容錯移轉期間自動建立的項目或虛擬機器都將刪除。
  
#### 範例

執行測試容錯移轉範例，如下所示：

1. 在您將用於內部部署虛擬機器之測試容錯移轉的相同網路中，執行 Active Directory 虛擬機器和 DNS 虛擬機器的測試容錯移轉。
2. 記下配置給這些已容錯移轉機器的 IP 位址。
3. 在用於測試容錯移轉的 Azure 虛擬網路中，新增 IP 位址做為 DNS 和 Active Directory 伺服器的位址。
4. 指定 Azure 網路，來進行虛擬機器的測試容錯移轉。
5. 在驗證測試失敗時可如預期般運作之後，請完成虛擬機器的容錯移轉，接著完成 Active Directory 和 DNS 虛擬機器的容錯移轉。

### 執行從主要內部部署站台到次要站台的測試容錯移轉

您必須執行一些動作來執行測試容錯移轉，包括建立 Active Directory 的複本，並將測試 DHCP 和 DNS 伺服器放在您的測試環境中。您可以使用下列幾種方式來執行這個動作：

- 如果您想要使用現有的網路來執行測試容錯移轉，請在該網路中準備 Active Directory、DHCP 和 DNS。
- 如果您想要使用自動建立 VM 網路的選項來執行測試容錯移轉，請在您將用於測試容錯移轉之復原方案中的群組 1 前新增手動步驟，然後將基礎結構資源新增到自動建立的網路，接著再執行測試容錯移轉。

#### 準備 Active Directory
若要執行測試容錯移轉以進行應用程式測試，您需要在測試環境中具有 Active Directory 生產環境的複本。以下是執行方式。

1. **建立複本** - 使用下列其中一個方法來建立 Active Directory 複本：

	- Hyper-V 複寫 - 您可以使用 Hyper-V 複寫來啟動 Active Directory 複寫，就像針對其他虛擬機器所做的一樣。當您執行復原方案的測試容錯移轉時，也可以執行 Active Directory 虛擬機器的測試容錯移轉。
	- Active Directory 複寫 - 您可以使用 Active Directory 複寫，在複本站台中建立 Active Directory 安裝的複本。當您執行復原方案的測試容錯移轉時，可以藉由取得複本 Active Directory 安裝的快照，來建立 Active Directory 虛擬機器的複本。您可以使用此複本進行測試容錯移轉。完成測試容錯移轉之後，您可以刪除 Active Directory 的複本。

2. **匯入和匯出** - 您可以匯出 Active Directory 虛擬機器，然後使用新的 GUID 來匯入它，藉以建立該虛擬機器的複本。
3. **新增到網路** - 將 Active Directory 新增到測試容錯移轉所建立的網路。請注意： 

	- 請務必確定您要新增 Active Directory 的網路會與您的生產網路完全隔離。如果您使用 Windows 網路類型的網路做為測試網路，系統保證會隔離自動建立的 VM 網路，讓您不需新增連接到網路的外部閘道。如果您使用的是 VLAN 架構的隔離，就必須確定所建立的 VM 網路會與您的生產環境隔離。
	- 根據 Active Directory 和 DNS 是在相同的虛擬機器或不同的虛擬機器上執行而定，您必須遵循的步驟順序可能稍有不同：
		- 相同的虛擬機器 - 如果 Active Directory 和 DNS 位於相同的虛擬機器上，您可以使用相同的虛擬機器做為 DNS 資源來進行測試容錯移轉。您可以選擇清除 DNS 中的所有項目，然後重新建立 DNS 中的必要區域。 
		- 不同的虛擬機器 - 如果 Active Directory 和 DNS 位於不同的虛擬機器上，您就需要建立 DNS 資源來進行測試容錯移轉。您可以使用全新的 DNS 伺服器，並建立所有的必要區域。例如，如果 Active Directory 網域是 contoso.com，您可以使用 contoso.com 的名稱來建立區域。 

4. **在 DNS 中更新 Active Directory** - 在這兩種情況下，對應至 Active Directory 的項目必須在 DNS 中更新。以下列方式來執行此動作：

	- 確定復原方案中的任何其他虛擬機器出現之前，下列設定均已完成：
		- 區域必須在樹系根名稱之後命名。
		- 區域必須是檔案備份的。
		- 區域必須能夠進行安全和非安全更新。
		- 如果 Active Directory 和 DNS 位於兩個不同的虛擬機器上，Active Directory 虛擬機器的解析程式應該指向 DNS 虛擬機器的 IP 位址。
	- 在 Active Directory 中執行下列命令：nltest /dsregdns。

#### 準備 DHCP

如果參與測試容錯移轉的虛擬機器會使用 DHCP，則應該在基於測試容錯移轉目的而建立的隔離網路中建立測試 DHCP 伺服器。

#### 準備 DNS

準備 DNS 伺服器來進行測試容錯移轉，如下所示：

- **DHCP** - 如果虛擬機器使用 DHCP，就應該在測試 DHCP 伺服器上更新測試 DNS 的 IP 位址。如果使用的是 Windows 網路虛擬化的網路類型，VMM 伺服器就會當做 DHCP 伺服器使用。因此，DNS 的 IP 位址應該在用來進行測試容錯移轉的靜態 IP 位址集區中進行更新。在此情況下，虛擬機器將會向相關的 DNS 伺服器註冊其本身。
- **靜態位址** - 如果虛擬機器使用靜態 IP 位址，就應該在用來測試容錯移轉的靜態 IP 位址集區中更新測試 DNS 伺服器的 IP 位址。您需要使用測試虛擬機器的 IP 位址來更新 DNS。您可以基於此目的來使用下列指令碼範例： 

	    Param(
	    [string]$Zone,
	    [string]$name,
	    [string]$IP
	    )
	    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
	    $newrecord = $record.clone()
	    $newrecord.RecordData[0].IPv4Address  =  $IP
	    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

- **加入區域** - 使用下列指令碼，在 DNS 伺服器上新增區域、允許不安全的更新，以及將適用於其本身的項目新增到 DNS：

	    dnscmd /zoneadd contoso.com  /Primary 
	    dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1 
	    dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM> 
	    dnscmd /config contoso.com /allowupdate 1

#### 執行測試

此程序說明如何針對復原方案執行非計劃性容錯移轉。或者，您可以在 [虛擬機器] 索引標籤上，針對單一虛擬機器或實體伺服器執行容錯移轉。

1. 選取 [復原方案] > *recoveryplan_name*。按一下 [容錯移轉] > [測試容錯移轉]。
2. 在 [確認測試容錯移轉] 頁面上，指定虛擬機器在測試容錯移轉後應如何連接到網路。
3. 在 [工作] 索引標籤上追蹤容錯移轉進度。當容錯移轉到達 [完成測試]**** 階段時，請按一下 [完成測試] 以完成測試容錯移轉。
4. 按一下 [記事] 記錄並儲存關於測試容錯移轉的任何觀察。
4. 完成之後，請確認虛擬機器已成功啟動。
5. 確認虛擬機器成功啟動之後，完成測試容錯移轉以清除隔離的環境。如果您選擇自動建立 VM 網路，清除功能會刪除所有的測試虛擬機器和測試網路。

請注意，如果測試容錯移轉持續兩週以上，系統就會強制完成它，並刪除在測試容錯移轉期間自動建立的任何項目或虛擬機器。

## 執行計劃性容錯移轉 (主要到次要)

 此程序說明如何針對復原方案執行計劃性容錯移轉。或者，您可以在 [虛擬機器] 索引標籤上針對單一虛擬機器執行容錯移轉。

1. 開始之前，請確定您想要容錯移轉的所有虛擬機器已都完成初始複寫。
2. 選取 [復原方案] > *recoveryplan_name*。按一下 [容錯移轉] > [計劃性容錯移轉]。 
3. 在 [確認計劃性容錯移轉]**** 頁面上，選擇來源與目標位置。記下容錯移轉方向。
	- 如果先前的容錯移轉已如預期般運作，而且所有虛擬機器伺服器都位於來源或目標位置上，則容錯移轉方向詳細資料僅供參考。 
	- 如果虛擬機器在來源和目標位置上均為使用中狀態，即會顯示 [變更方向] 按鈕。使用此按鈕，來變更及指定應進行容錯移轉的方向。

5. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰] 中，選取當您在提供者安裝期間於 VMM 伺服器上啟用資料加密時所發出的憑證。
6. 開始計劃性容錯移轉的第一個步驟是關閉虛擬機器，以確保資料不會遺失。您可以在 [工作] 索引標籤上追蹤容錯移轉進度。如果容錯移轉中發生錯誤 (無論是在虛擬機器上或在復原方案中包含的指令碼中)，復原方案的計劃性容錯移轉即會停止。您可以再次起始容錯移轉。
8. 建立複本虛擬機器之後，它們即會處於認可擱置中的狀態。按一下 [認可] 以認可容錯移轉。 
9. 完成複寫之後，即會在次要位置上啟動虛擬機器。 

## 執行非計劃性容錯移轉

此程序說明如何針對復原方案執行非計劃性容錯移轉。或者，您可以在 [虛擬機器] 索引標籤上，針對單一虛擬機器或實體伺服器執行容錯移轉。

1. 選取 [復原方案] > *recoveryplan_name*。按一下 [容錯移轉] > [非計劃性容錯移轉]。 
3. 在 [確認非計劃性容錯移轉]**** 頁面上，選擇來源與目標位置。記下容錯移轉方向。
	- 如果先前的容錯移轉已如預期般運作，而且所有虛擬機器伺服器都位於來源或目標位置上，則容錯移轉方向詳細資料僅供參考。 
	- 如果虛擬機器在來源和目標位置上均為使用中狀態，即會顯示 [變更方向] 按鈕。使用此按鈕，來變更及指定應進行容錯移轉的方向。

4. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰] 中，選取當您在提供者安裝期間於 VMM 伺服器上啟用資料加密時所發出的憑證。
5. 選取 [關閉虛擬機器並同步處理最新資料]，來指定 Site Recovery 應嘗試關閉受保護的虛擬機器並同步處理資料，以便為最新的資料版本進行容錯移轉。如果您未選取此選項或嘗試失敗，容錯移轉將會來自虛擬機器的最新可用復原點。
6. 您可以在 [工作] 索引標籤上追蹤容錯移轉進度。請注意，即使在非計劃性容錯移轉期間發生錯誤，復原方案還是會執行，直到它完成為止。
7. 容錯移轉之後，虛擬機器就會處於 [認可擱置中] 狀態。按一下 [認可] 以認可容錯移轉。
8. 如果您設定複寫以使用多個復原點，則可在 [變更復原點] 中選擇使用不是最新的復原點 (預設會使用最新的復原點)。當您認可之後，將移除其他復原點。
9. 完成複寫之後，虛擬機器即會在次要位置上啟動並執行。不過，它們不會受到保護或進行複寫。再次使用相同的基礎結構來使用主要站台時，請按一下 [反向複寫]，開始進行反向複寫。這可確保所有資料都會複寫回到主要站台，而且虛擬機器已準備好再次進行容錯移轉。非計劃性容錯移轉之後的反向複寫會導致在資料傳輸中產生額外負荷。傳輸所使用的方式與針對適用於雲端之初始複寫設定所設定的方法相同。

## 從次要位置容錯回復到主要位置

 從主要位置容錯移轉到次要位置之後，複寫的虛擬機器就不會受到 Site Recovery 所保護，而次要位置現在會成為主要位置。請遵循這些程序，以容錯回復到原始的主要站台。此程序說明如何針對復原方案執行計劃性容錯移轉。或者，您可以在 [虛擬機器] 索引標籤上針對單一虛擬機器執行容錯移轉。

1. 選取 [復原方案] > *recoveryplan_name*。按一下 [容錯移轉] > [計劃性容錯移轉]。
2. 在 [確認計劃性容錯移轉]**** 頁面上，選擇來源與目標位置。記下容錯移轉方向。如果來自主要位置的容錯移轉會如預期般運作，且所有虛擬機器均位於次要位置，則這僅供參考。3. 如果您正從 Azure 進行容錯回復，請選取 [資料同步處理] 中的設定：

	- **容錯移轉之前同步處理資料** - 這個選項可將虛擬機器的停機時間降至最低，因為不需關閉虛擬機器即可進行同步處理。它具有下列功能：
		- 階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。機器會繼續在 Azure 中執行。
		- 階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。最後一組變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。
	
	> [AZURE.NOTE]如果您已經執行 Azure 一段時間 (一個月或以上)，建議您使用此選項。這個選項可在不關閉虛擬機器的情況下執行同步處理。它不會執行重新同步處理，但會執行完整的容錯回復。這個選項不會執行任何總和檢查碼計算。

	- **僅在容錯移轉期間同步處理資料** - 如果您只是在 Azure 上短時間執行，請使用這個選項。這個選項速度較快，因為它會重新同步處理，而不是進行完整的容錯回復。它會執行快速的總和檢查碼計算，而且只下載變更的區塊。

5. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰] 中，選取當您在提供者安裝期間於 VMM 伺服器上啟用資料加密時所發出的憑證。
5. 預設會使用最新的復原點，但您可以在 [變更復原點] 中指定不同的復原點。 
6. 按一下勾號以開始容錯回復。您可以在 [工作] 索引標籤上追蹤容錯移轉進度。 
7. 如果您選取要在容錯移轉前同步處理資料的選項，則在完成初始資料同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [工作] > <planned failover job name> [完成容錯移轉]。這會將 Azure 機器關機、將最新變更傳送到內部部署虛擬機器，然後啟動它。
8. 您現在可以登入虛擬機器，來驗證它是否會如預期般出現。 
9. 虛擬機器目前處於認可擱置中的狀態。按一下 [認可] 以認可容錯移轉。
10. 現在為了完成容錯回復，請按一下 [反向複寫]，開始保護主要站台中的虛擬機器。



## 容錯回復到其他位置

如果您已經在 [HYPER-V 站台和 Azure](site-recovery-hyper-v-site-to-azure.md) 之間部署保護，就能夠從 Azure 容錯回復到替代的內部部署位置。如果您需要設定新的內部部署硬體，這相當實用。以下是執行此動作的方式。

1. 如果您正在設定新硬體，請在伺服器上安裝 Windows Server 2012 R2 和 Hyper-V 角色。
2. 使用您在原始伺服器上所擁有的相同名稱來建立虛擬網路交換器。
3. 選取 [受保護的項目] -> [保護群組] -> <ProtectionGroupName> -> <VirtualMachineName>您想要進行容錯回復，然後選取 [計劃性容錯移轉]。
4. 在 [確認計劃性容錯移轉] 中，選取 [如果內部部署虛擬機器不存在，則建立一個]。 
5. 在 [主機名稱] 中，選取要放置虛擬機器的新 Hyper-V 主機伺服器。
6. 在 [資料同步處理] 中，建議您選取 [容錯移轉之前同步處理資料] 的選項。這個選項可以將虛擬機器的停機時間降至最低，因為不需關閉虛擬機器即可進行同步處理。它具有下列功能：

	- 階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。機器會繼續在 Azure 中執行。
	- 階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。最後一組變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。
	
7. 按一下勾號以開始容錯移轉 (容錯回復)。
8. 完成初始同步處理並準備好將 Azure 中的虛擬機器關機之後，按一下 [工作] > <planned failover job> > [完成容錯移轉]。這會將 Azure 機器關機、將最新變更傳送到內部部署虛擬機器，然後啟動它。
9. 您可以登入內部部署虛擬機器，確認一切均可正常運作。然後按一下 [認可] 以完成容錯移轉。
10. 按一下 [反向複寫]，開始保護內部部署虛擬機器。

 

<!---HONumber=July15_HO2-->