<properties
	pageTitle="應用程式模型 v2.0 | Microsoft Azure"
	description="Azure AD v2.0 應用程式模型公開預覽版支援的通訊協定。"
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/12/2015"
	ms.author="dastrock"/>

# 應用程式模型 v2.0 預覽版：通訊協定 - OAuth 2.0 和 OpenID Connect

v2.0 應用程式模型透過支援業界標準通訊協定、OpenID Connect 和 OAuth 2.0，為應用程式提供身分識別即服務。雖然此服務是標準相容，但這些通訊協定任兩個實作之間仍會有些微差異。如果您選擇藉由直接傳送和處理 HTTP 要求來撰寫程式碼，而非使用我們其中一個開放原始碼程式庫，則這裡的資訊會很有用。<!-- TODO: Need link to libraries above -->

> [AZURE.NOTE]此資訊適用於 v2.0 應用程式模型公開預覽。如需如何與正式運作之 Azure AD 服務整合的相關資訊，請參閱 [Azure Active Directory 開發人員指南](active-directory-developers-guide.md)。

## 權杖
OAuth 2.0 和 OpenID Connect 的 v2.0 應用程式模型實作廣泛運用持有者權杖，包括以 JWT 表示的持有者權杖。持有人權杖是輕巧型的安全性權杖，授權「持有者」存取受保護的資源。從這個意義上說，「持有者」是可出示權杖的任何一方。雖然某一方必須先向 Azure AD 驗證以收到持有者權杖，但如果傳輸和儲存時未採取必要的步驟來保護權杖，它可能會被非預期的一方攔截和使用。雖然某些安全性權杖都有內建的機制，可防止未經授權的人士使用權杖，但持有者權杖沒有這項機制，而必須以安全通道來傳輸，例如傳輸層安全性 (HTTPS)。如果持有人權杖以純文字傳輸，惡意人士可能使用攔截式攻擊來取得權杖，然後未經授權存取受保護的資源。儲存或快取持有者權杖供以後使用時，也適用相同的安全性原則。務必確定您的應用程式以安全的方式傳輸和儲存持有者權杖。關於持有者權杖的其他安全性考量，請參閱 [RFC 6750 第 5 節](http://tools.ietf.org/html/rfc6750)。

如需 v2.0 應用程式模型中使用的不同類型權杖的詳細說明，請參閱 [v2.0 應用程式模型權杖參考](active-directory-v2-tokens.md)。

## 基本概念
所有使用 v2.0 應用程式模型的應用程式都必須在 [apps.dev.microsoft.com](https://apps.dev.microsoft.com) 註冊。應用程式註冊處理序會收集與指派一些值給您的應用程式：

- 可唯一識別應用程式的**應用程式 ID**
- 可將回應導回至應用程式的**重新導向 URI**或**封裝識別碼**
- 其他幾個狀況特定的值。如需詳細資訊，請了解如何[註冊應用程式](active-directory-v2-app-registration.md)。

註冊之後，應用程式即會與 Azure AD 通訊，向 v2.0 端點傳送要求：

```
https://login.microsoftonline.com/common/oauth2/v2.0/authorize
https://login.microsoftonline.com/common/oauth2/v2.0/token
```

幾乎在所有的 OAuth 和 OpenID Connect 流程中，都有四個參與交換的合作對象：

![OAuth 2.0 角色](../media/active-directory-v2-flows/protocols_roles.png)

- **授權伺服器**是 v2.0 端點。其負責確保使用者的身分識別、授與及撤銷資源存取權，以及核發權杖。其也稱作為識別提供者：安全地處理與使用者資訊、使用者存取權，以及流程中合作對象彼此間信任關係有關的任何項目。
- **資源擁有者**通常是使用者。其是擁有資料的一方，而且有權允許第三方存取該資料或資源。
- **OAuth 用戶端**是您的應用程式，透過其應用程式識別碼加以識別。其通常是與使用者互動的對象，而且會向授權伺服器要求權杖。用戶端必須獲得資源擁有者授權才能存取資源。
- **資源伺服器**是資源或資料所在位置。其信任授權伺服器會安全地驗證及授權 OAuth 用戶端，並使用 Bearer access\_token 來確保可以授與資源的存取權。

## OAuth2 授權碼流程
關於 OAuth 2.0 授權碼流程的說明，請參閱 [OAuth 2.0 規格 4.1 節](http://tools.ietf.org/html/rfc6749)。在大部分的應用程式類型中，其用於執行驗證與授權，包括 [Web Apps](active-directory-v2-flows.md#web-apps) 和[原始安裝的應用程式](active-directory-v2-flows.md#mobile-and-native-apps)。其可讓應用程式安全地取得 access\_token，這些權杖可用於存取以 v2.0 應用程式模型保護的資源。

以下是原生應用程式的完整流程，下列各節會詳細說明每個要求：![OAuth 授權碼流程](../media/active-directory-v2-flows/convergence_scenarios_native.png)

#### 要求授權碼
授權碼流程始於用戶端將使用者導向 `/authorize` 端點。在這項要求中，用戶端會指出必須向使用者索取的權限：

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=											   // See table below for scope parameter details.
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345						 				 // Any value provided by your app
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | ----------------------- |
| client\_id | 必要 | 註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給應用程式的應用程式識別碼。 |
| response\_type | 必要 | 授權碼流程必須包含 `code`。 |
| redirect\_uri | 必要 | 您的應用程式可在應用程式的 redirect\_uri 傳送及接收驗證回應。其必須完全符合您在入口網站中註冊的其中一個 redirect\_uris，不然就必須得是編碼的 url。 |
| scope | 必要 | 範圍的空格分隔清單。v2.0 端點的單一範圍值為資源和所要求資源的權限。範圍的形式為 `<app identifier URI>/<scope value>`。上例中使用了 Azure AD Graph API 的應用程式識別碼 `https://graph.windows.net`，並要求了兩項權限：`directory.read` 和 `directory.write`。如需範圍的詳細說明，請參閱 c。 |
| response\_mode | 建議使用 | 指定將產生的 authorization\_code 傳回到應用程式所應該使用的方法。可以是 'query'、'form\_post' 或 'fragment' 其中一種。
| state | 建議使用 | 同樣會隨權杖回應傳回之要求中所包含的值。其可以是您想要之任何內容的字串。隨機產生的唯一值通常用於防止跨站台要求偽造攻擊。此狀態也用於在驗證要求出現之前，於應用程式中編碼使用者的狀態資訊，例如之前所在的網頁或檢視。 |
| prompt | 選用 | 表示需要的使用者互動類型。此時唯一有效的值是 'login'，強制使用者針對該要求輸入其認證。單一登入不會生效。 |

此時，會要求使用者輸入其認證並完成驗證。v2.0 端點也會確保使用者已經同意 `scope` 查詢參數所示的權限。如果使用者未曾同意這些權限的任何一項，就會要求使用者同意要求的權限。[這裡提供權限、同意與多租用戶應用程式](active-directory-v2-scopes.md)的詳細資料。

一旦使用者驗證並同意，v2.0 端點就會使用 `response_mode` 參數中指定的方法，將回應傳回至位於指定所在 `redirect_uri` 的應用程式。

使用 `response_mode=query` 的成功回應如下所示：

```
GET https://localhost/myapp/?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq... 	// the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  							// the value provided in the request
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| code | 應用程式要求的 authorization\_code。應用程式可以使用授權碼要求目標資源的存取權杖。Authorization\_code 的有效期很短，通常約 10 分鐘後即到期。 |
| session\_state | 識別目前使用者工作階段的唯一值。這個值是 GUID，但應視為不檢查即傳遞的不透明值。 |
| state | 如果要求中包含狀態參數，回應中就應該出現相同的值。應用程式應該確認要求和回應中的狀態值完全相同。 |

錯誤回應可能也會傳送至 `redirect_uri`，讓應用程式可以適當地處理：

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error\_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。 |

#### 要求存取權杖
既然您已經取得 authorization\_code 並獲得使用者授權，您就可以將 `POST` 要求傳送至 `/token` 端點，贖回 `code` 以取得所需資源的 `access_token`：

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "authorization_code",
	"client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | --------------------- |
| client\_id | 必要 | 註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給應用程式的應用程式識別碼。 |
| grant\_type | 必要 | 必須是授權碼流程的 `authorization_code`。 |
| scope | 必要 | 範圍的空格分隔清單。在此階段中要求的範圍必須相當於或為第一個階段中所要求的範圍子集。如果這個要求中指定的範圍遍及多個資源伺服器，v2.0 端點就會傳回第一個範圍內所指定資源的權杖。如需範圍的詳盡說明，請參閱[權限、同意和範圍](active-directory-v2-scopes.md)。 |
| code | 必要 | 您在流程的第一個階段中取得的 authorization\_code。 |
| client\_secret | Web Apps 所需 | 您在應用程式註冊入口網站中為應用程式建立的應用程式密碼。其不應用於原生應用程式，因為裝置無法穩當地儲存 client\_secret。Web Apps 和 Web API 都需要應用程式密碼，其能夠將 client\_secret 安全地儲存在伺服器端。 |

成功的權杖回應如下：

```
{
	"access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"token_type": "Bearer",
	"expires_in": "3600",
	"expires_on": "1388444763",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```
| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| access\_token | 所要求的存取權杖。應用程式可以使用這個權杖驗證受保護的資源，例如 Web API。 |
| token\_type | 表示權杖類型值。Azure AD 唯一支援的類型是 Bearer。 |
| expires\_in | 存取權杖的有效期 (以秒為單位)。 |
| expires\_on | 存取權杖的到期時間。日期以 Epoch 時間的秒數表示。 |
| scope | access\_token 有效的範圍。 |
| refresh\_token | OAuth 2.0 重新整理權杖。應用程式可以使用這個權杖，在目前的存取權杖過期之後，取得其他的存取權杖。Refresh\_token 的有效期很長，而且可以用來延長保留資源存取權的時間。如需詳細資訊，請參閱 [v2.0 權杖參考](active-directory-v2-tokens.md)。 |
| id\_token | 不帶正負號的 JSON Web Token (JWT)。應用程式可以 base64Url 解碼這個權杖的區段，要求已登入使用者的相關資訊。應用程式可以快取並顯示值，但不應依賴這些值來取得任何授權或安全性界限。如需 id\_token 的詳細資訊，請參閱 [v2.0 應用程式模型權杖參考](active-directory-v2-tokens.md)。 |

錯誤回應格式如下：

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error\_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。 |

#### 使用存取權杖
既然您已經成功取得 `access_token`，您就可以透過在 `Authorization` 標頭中包含權杖，在 Web API 的要求中使用權杖：

```
GET /contoso.onmicrosoft.com/users
Host: https://graph.windows.net
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

#### 重新整理存取權杖
Access\_token 有效期很短，且您必須在其到期後重新整理，才能繼續存取資源。方法是：向 `/authorize` 端點送出另一個 `POST` 要求，這次提供 `refresh_token`，而不提供 `code`：

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "refresh_token",
	"client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...",
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | -------- |
| client\_id | 必要 | 註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給應用程式的應用程式識別碼。 |
| grant\_type | 必要 | 必須是授權碼流程此階段的 `refresh_token`。 |
| scope | 必要 | 範圍的空格分隔清單。在此階段中要求的範圍必須相當於或為原始 authorization\_code 要求階段中所要求的範圍子集。如果這個要求中指定的範圍遍及多個資源伺服器，v2.0 端點就會傳回第一個範圍內所指定資源的權杖。如需範圍的詳盡說明，請參閱[權限、同意和範圍](active-directory-v2-scopes.md)。 |
| refresh\_token | 必要 | 您在流程的第二個階段中取得的 refresh\_token。 |
| client\_secret | Web Apps 所需 | 您在應用程式註冊入口網站中為應用程式建立的應用程式密碼。其不應用於原生應用程式，因為裝置無法穩當地儲存 client\_secret。Web Apps 和 Web API 都需要應用程式密碼，其能夠將 client\_secret 安全地儲存在伺服器端。 |

成功的權杖回應如下：

```
{
	"access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"token_type": "Bearer",
	"expires_in": "3600",
	"expires_on": "1388444763",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```
| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| access\_token | 所要求的存取權杖。應用程式可以使用這個權杖驗證受保護的資源，例如 Web API。 |
| token\_type | 表示權杖類型值。Azure AD 唯一支援的類型是 Bearer。 |
| expires\_in | 存取權杖的有效期 (以秒為單位)。 |
| expires\_on | 存取權杖的到期時間。日期以 Epoch 時間的秒數表示。 |
| scope | access\_token 有效的範圍。 |
| refresh\_token | 新的 OAuth 2.0 重新整理權杖。您應該用新取得的重新整理權杖取代舊的重新整理權杖，以確定盡可能保持重新整理權杖有效的時間。 |
| id\_token | 不帶正負號的 JSON Web Token (JWT)。應用程式可以 base64Url 解碼這個權杖的區段，要求已登入使用者的相關資訊。應用程式可以快取並顯示值，但不應依賴這些值來取得任何授權或安全性界限。如需 id\_token 的詳細資訊，請參閱 [v2.0 應用程式模型權杖參考](active-directory-v2-tokens.md)。 |

錯誤回應格式如下：

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error\_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。 |






## OpenID Connect 登入流程
[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) 擴充 OAuth 2.0 *授權*通訊協定，用為*驗證*通訊協定，讓您使用 OAuth 執行單一登入。其介紹 `id_token` 的概念，這是一種安全性權杖，可讓用戶端驗證使用者的身分識別，並取得有關使用者的基本設定檔資訊。

實作 [Web 應用程式](active-directory-v2-flows.md#web-apps)的登入時，建議使用適用於 v2.0 應用程式模型的 OpenID Connect。最基本的登入流程包含下列步驟：

![OpenId Connect 區隔線](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

#### 傳送登入要求
當您的 Web 應用程式需要驗證使用者時，其可以將使用者導向至 `/authorize` 端點。這個要求類似於 [OAuth 2.0 授權碼流程](#oauth2-authorization-code-flow)的第一個階段，但有幾個重要區別：- 要求必須在 `scope` 參數中包含範圍 `openid`。- `response_type` 參數必須包含 `id_token`。- 要求必須包含 `nonce` 參數。

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=openid										 // Translates to the 'Read your profile' permission
&state=12345						 				 // Any value, provided by your app
&nonce=678910										 // Any value, provided by your app
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | --------------- |
| client\_id | 必要 | 註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給應用程式的應用程式識別碼。 |
| response\_type | 必要 | 必須包含 OpenID Connect 登入的 `id_token`。其也可以包含其他 response\_type，如 [OpenID Connect 與 OAuth 程式碼流程](#OpenID-Connect-with-OAuth-Code-Flow)一節所述。 |
| redirect\_uri | 必要 | 應用程式的 redirect\_uri，您的應用程式可在此傳送及接收驗證回應。其必須完全符合您在入口網站中註冊的其中一個 redirect\_uris，不然就必須得是編碼的 url。 |
| scope | 必要 | 範圍的空格分隔清單。針對 OpenID Connect，即必須包含範圍 `openid`，其會在同意 UI 中轉譯成「登入及讀取設定檔」。您也可以在此要求中包含其他範圍以要求同意，如 [OpenID Connect 與 OAuth 程式碼流程](#OpenID-Connect-with-OAuth-Code-Flow)一節中所述。 |
| nonce | 必要 | 由應用程式產生且包含在要求中的值，會以宣告方式包含在產生的 id\_token 中。應用程式接著便可確認此值，以減少權杖重新執行攻擊。此值通常是隨機的唯一字串，可用以識別要求的來源。 |
| response\_mode | 建議使用 | 指定將產生的 authorization\_code 傳回到應用程式所應該使用的方法。可以是 'query'、'form\_post' 或 'fragment' 其中一種。  
| state | 建議使用 | 同樣會隨權杖回應傳回之要求中所包含的值。其可以是您想要之任何內容的字串。隨機產生的唯一值通常用於防止跨站台要求偽造攻擊。此狀態也用於在驗證要求出現之前，於應用程式中編碼使用者的狀態資訊，例如之前所在的網頁或檢視。 |
| prompt | 選用 | 表示需要的使用者互動類型。此時唯一有效的值是 'login'，強制使用者針對該要求輸入其認證。單一登入不會生效。 |

此時，會要求使用者輸入其認證並完成驗證。v2.0 端點也會確保使用者已經同意 `scope` 查詢參數所示的權限。如果使用者未曾同意這些權限的任何一項，就會要求使用者同意要求的權限。[這裡提供權限、同意與多租用戶應用程式](active-directory-v2-scopes.md)的詳細資料。

一旦使用者驗證並同意，v2.0 端點就會使用 `response_mode` 參數中指定的方法，將回應傳回至位於指定所在 `redirect_uri` 的應用程式。

使用 `response_mode=query` 的成功回應如下所示：

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request

```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| id\_token | 應用程式要求的 id\_token。您可以使用 id\_token 確認使用者的身分識別，並以使用者開始工作階段。如需 Id\_token 及其內容的詳細資訊，請參閱 [v2.0 端點權杖參考](active-directory-v2-tokens.md)。 |
| session\_state | 識別目前使用者工作階段的唯一值。這個值是 GUID，但應視為不檢查即傳遞的不透明值。 |
| state | 如果要求中包含狀態參數，回應中就應該出現相同的值。應用程式應該確認要求和回應中的狀態值完全相同。 |

錯誤回應可能也會傳送至 `redirect_uri`，讓應用程式可以適當地處理：

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error\_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。 |

#### 驗證 id\_token
僅接收 id\_token 不足以驗證使用者，您必須驗證 id\_token 簽章，並依照應用程式的需求確認權杖中的宣告。v2.0 端點使用 [JSON Web Tokens (JWT)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) 和公開金鑰加密簽署權杖及驗證其是否有效。

v2.0 應用程式模型具有 OpenID Connect 中繼資料端點，可在執行階段讓應用程式提取 v2.0 應用程式模型的相關資訊。這項資訊包括端點、權杖內容和權杖簽署金鑰。中繼資料端點包含下列位置的 JSON 文件：

`https://login.microsoftonline.com/common/v2.0/.well-known/configuration`

此設定文件的屬性之一是 `jwks_uri`，其 v2.0 應用程式模型的值會是：

`https://login.microsoftonline.com/common/discovery/v2.0/keys`。

您可以使用位於此端點的 RSA256 公用金鑰驗證 id\_token 的簽章。此端點在任何指定的時間點都有列出多組金鑰，每組金鑰都由 `kid` 識別。Id\_token 標頭也包含 `kid` 宣告，其指出簽署 id\_token 所使用的金鑰。

如需詳細資訊，請參閱 [v2.0 應用程式模型權杖參考](active-directory-v2-tokens.md)，包括[驗證權杖](active-directory-v2-tokens.md#validating-tokens)和[有關簽署金鑰變換的重要資訊](active-directory-v2-tokens.md#validating-tokens)。<!--TODO: Improve the information on this-->

一旦驗證了 id\_token 的簽章，就會有數項宣告需要驗證：

- 您應該驗證 `nonce` 宣告以防止權杖重新執行攻擊。其值應該是您在登入要求中所指定的內容。
- 您應該驗證 `aud` 宣告以確保已為應用程式核發 id\_token。其值應該是應用程式的 `client_id`。
- 您應該驗證 `iat` 和 `exp` 宣告以確保 id\_token 未過期。

您可能也希望根據自己的案例驗證其他宣告。一些常見的驗證包括：

- 確保使用者/組織已註冊應用程式。
- 確保使用者擁有正確的授權/權限
- 確保驗證具有特定強度，例如多重要素驗證。

如需 id\_token 中宣告的詳細資訊，請參閱 [v2.0 應用程式模型權杖參考](active-directory-v2-tokens.md)。

一旦驗證完畢 id\_token，即可利用使用者開始工作階段，並使用 id\_token 中的宣告來取得應用程式中的使用者相關資訊。這項資訊可以用於顯示、記錄、授權等等。

#### 傳送登出要求

v2.0 應用程式模型預覽版目前不支援 OpenIdConnect `end_session_endpoint`。這表示應用程式無法向 v2.0 端點傳送要求，而無法結束使用者工作階段及清除 v2.0 端點設定的 Cookie。若要將使用者登出，應用程式只需結束自身的使用者工作階段，並完整地將使用者工作階段留給 v2.0 端點即可。下次使用者嘗試登入時，就會看到列出其主動登入帳戶的 [選擇帳戶] 頁面。在該頁面上，使用者可以選擇登出任一帳戶，結束 v2.0 端點的工作階段。

<!--

When you wish to sign the user out of the  app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.

You can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Parameter | | Description |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |

-->

## OpenID Connect 與 OAuth 程式碼流程
許多 Web Apps 需要將使用者登入，並使用 OAuth 代表使用者來存取 Web 服務。這個案例合併了上述兩個工作階段：其使用 OpenID Connect 進行使用者驗證，並同時使用 OAuth 授權碼流程取得可用來取得 access\_token 的 authorization\_code：

![OpenId Connect 區隔線](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)

這個流程與上述工作階段只在傳送登入要求部分上有些微差異。

#### 傳送登入要求
當您的 Web 應用程式需要驗證使用者並取得存取資源所需的權限時，其可以將使用者導向至 `/authorize` 端點。在此情況下，應用程式必須要求回應中要有 `id_token` 和 `code`

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token+code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=openid%20										 // Include both 'openid' and scopes your app needs  
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345						 				 // Any value, provided by your app
&nonce=678910										 // Any value, provided by your app
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | ----------------- |
| client\_id | 必要 | 註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給應用程式的應用程式識別碼。 |
| response\_type | 必要 | 必須包含這個案例的 `id_token` 和 `code`。 |
| redirect\_uri | 必要 | 應用程式的 redirect\_uri，您的應用程式可在此傳送及接收驗證回應。其必須完全符合您在入口網站中註冊的其中一個 redirect\_uris，不然就必須得是編碼的 url。 |
| scope | 必要 | 範圍的空格分隔清單。針對 OpenID Connect，即必須包含範圍 `openid`，其會在同意 UI 中轉譯成「登入及讀取設定檔」。您也必須包含應用程式需要存取的資源範圍。如需範圍的詳盡說明，請參閱[權限、同意和範圍](active-directory-v2-scopes.md)。 |
| nonce | 必要 | 由應用程式產生且包含在要求中的值，會以宣告方式包含在產生的 id\_token 中。應用程式接著便可確認此值，以減少權杖重新執行攻擊。此值通常是隨機的唯一字串，可用以識別要求的來源。 |
| response\_mode | 建議使用 | 指定將產生的 authorization\_code 傳回到應用程式所應該使用的方法。可以是 'query'、'form\_post' 或 'fragment' 其中一種。  
| state | 建議使用 | 同樣會隨權杖回應傳回之要求中所包含的值。其可以是您想要之任何內容的字串。隨機產生的唯一值通常用於防止跨站台要求偽造攻擊。此狀態也用於在驗證要求出現之前，於應用程式中編碼使用者的狀態資訊，例如之前所在的網頁或檢視。 |
| prompt | 選用 | 表示需要的使用者互動類型。此時唯一有效的值是 'login'，強制使用者針對該要求輸入其認證。單一登入不會生效。 |

此時，會要求使用者輸入其認證並完成驗證。v2.0 端點也會確保使用者已經同意 `scope` 查詢參數所示的權限。如果使用者未曾同意這些權限的任何一項，就會要求使用者同意要求的權限。[這裡提供權限、同意與多租用戶應用程式](active-directory-v2-scopes.md)的詳細資料。

一旦使用者驗證並同意，v2.0 端點就會使用 `response_mode` 參數中指定的方法，將回應傳回至位於指定所在 `redirect_uri` 的應用程式。

使用 `response_mode=query` 的成功回應如下所示：

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq... 	// the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request

```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| id\_token | 應用程式要求的 id\_token。您可以使用 id\_token 確認使用者的身分識別，並以使用者開始工作階段。如需 Id\_token 及其內容的詳細資訊，請參閱 [v2.0 應用程式模型權杖參考](active-directory-v2-tokens.md)。 |
| code | 應用程式要求的 authorization\_code。應用程式可以使用授權碼要求目標資源的存取權杖。Authorization\_code 的有效期很短，通常約 10 分鐘後即到期。 |
| session\_state | 識別目前使用者工作階段的唯一值。這個值是 GUID，但應視為不檢查即傳遞的不透明值。 |
| state | 如果要求中包含狀態參數，回應中就應該出現相同的值。應用程式應該確認要求和回應中的狀態值完全相同。 |

錯誤回應可能也會傳送至 `redirect_uri`，讓應用程式可以適當地處理：

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error\_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。 |

#### 驗證 id\_token
這個程序與 [OpenID Connect 登入流程](#OpenID-Connect-Sign-In-Flow)所述完全一致。

#### 傳送登出要求
這個程序與 [OpenID Connect 登入流程](#OpenID-Connect-Sign-In-Flow)所述完全一致。

#### 要求存取權杖
這個程序與 [OAuth 2.0 授權碼流程](#oauth2-authorization-code-flow)所述完全一致。

#### 使用存取權杖
這個程序與 [OAuth 2.0 授權碼流程](#oauth2-authorization-code-flow)所述完全一致。

#### 重新整理存取權杖
這個程序與 [OAuth 2.0 授權碼流程](#oauth2-authorization-code-flow)所述完全一致。





## OAuth2 用戶端認證授與流程
OAuth 2.0 用戶端認證授與相關說明，請參閱 [OAuth 2.0 規格](http://tools.ietf.org/html/rfc6749#section-4.4)。其對長時間執行的程序和其他伺服器對伺服器的案例非常有用，因為應用程式可以使用自身的「應用程式身分識別」驗證資源，而非使用者的委派身分識別。

v2.0 應用程式模型預覽版目前不支援這個流程。若要查看其在正式運作之 Azure AD 服務中的運作方式，請參閱[這個 Azure AD 程式碼範例](https://github/com/AzureADSamples/Daemon-DotNet)。

## OAuth2 隱含流程
OAuth 2.0 隱含流程相關說明，請參閱 [OAuth 2.0 規格](http://tools.ietf.org/html/rfc6749#section-4.2)。其通常用於在瀏覽器中執行的單一頁面/javascript 應用程式。

v2.0 應用程式模型預覽版目前不支援這個流程。若要查看其在正式運作之 Azure AD 服務中的運作方式，請參閱[這個 Azure AD 程式碼範例](active-directory-devquickstarts-angular.md)。

## OAuth2 資源擁有者密碼認證授與
有關 OAuth 2.0 資源擁有者密碼認證授與的說明，請參閱 [OAuth 2.0 規格](http://tools.ietf.org/html/rfc6749#section-4.3)。其在權杖要求中提供使用者的使用者名稱與密碼，讓應用程式可以取得 access\_token。

v2.0 應用程式模型預覽版目前不支援這個流程。若要查看其在正式運作之 Azure AD 服務中的運作方式，請參閱[這個 Azure AD 程式碼範例](https://github.com/AzureADSamples/NativeClient-Headless-DotNet)。

## OAuth2 代理者流程
關於「代理者流程」(或稱「JWT 持有人認證授與」) 的說明，請參閱 [OAuth 2.0 延伸模組授與草稿](https://tools.ietf.org/html/draft-ietf-oauth-jwt-bearer-12)。其可讓接收 access\_token 的 Web API 將該 access\_token 用為認證，以取得其他資源的 access\_token。這讓 Web API 可以安全地呼叫另一個下游 Web API。

v2.0 應用程式模型預覽版目前不支援這個流程。若要查看其在正式運作之 Azure AD 服務中的運作方式，請參閱[這個 Azure AD 程式碼範例](https://github.com/AzureADSamples/WebAPI-OnBehalfOf-DotNet)。

<!---HONumber=August15_HO7-->